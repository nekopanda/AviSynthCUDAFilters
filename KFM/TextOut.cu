// Taken and slightly modified from decomb filter package by 
// Donald Graft which has the following msg:
//
//      Borrowed from the author of IT.dll, whose name I
//      could not determine. Modified for YV12 by Donald Graft.
#include "avisynth.h"
#include <string>
#include <vector>
#include <algorithm>
#include <numeric>

#include "CommonFunctions.h"
#include "Frame.h"

#ifdef __CUDA_ARCH__
#define CONSTANT __constant__
#else
#define CONSTANT
#endif

static const CONSTANT unsigned short font[][20] =
{
  //STARTCHAR space
  {
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR !
  {
    0x0000,0x0000,0x0c00,0x0c00,
    0x0c00,0x0c00,0x0c00,0x0c00,
    0x0c00,0x0c00,0x0c00,0x0c00,
    0x0000,0x0c00,0x0c00,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR "
  {
    0x0000,0x0000,0x3300,0x3300,
    0x3300,0x1200,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR #
  {
    0x0000,0x0000,0x0000,0x0d80,
    0x0d80,0x0d80,0x3fc0,0x1b00,
    0x1b00,0x1b00,0x7f80,0x3600,
    0x3600,0x3600,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR $
  {
    0x0000,0x0000,0x0c00,0x3f00,
    0x6d80,0x6c00,0x6c00,0x6c00,
    0x3f00,0x0d80,0x0d80,0x0d80,
    0x6d80,0x3f00,0x0c00,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR %
  {
    0x0000,0x0000,0x0000,0x3980,
    0x6d80,0x6f00,0x3b00,0x0600,
    0x0600,0x0c00,0x0c00,0x1b80,
    0x1ec0,0x36c0,0x3380,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR &
  {
    0x0000,0x0000,0x1c00,0x3600,
    0x3600,0x3600,0x3c00,0x1800,
    0x3800,0x6c00,0x66c0,0x6380,
    0x6300,0x7780,0x3cc0,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR '
  {
    0x0000,0x0000,0x0f00,0x0e00,
    0x1800,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR (
  {
    0x0000,0x0000,0x0300,0x0600,
    0x0c00,0x0c00,0x1800,0x1800,
    0x1800,0x1800,0x1800,0x0c00,
    0x0c00,0x0600,0x0300,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR )
  {
    0x0000,0x0000,0x3000,0x1800,
    0x0c00,0x0c00,0x0600,0x0600,
    0x0600,0x0600,0x0600,0x0c00,
    0x0c00,0x1800,0x3000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR *
  {
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x3300,0x3300,0x1e00,
    0x7f80,0x1e00,0x3300,0x3300,
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR +
  {
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0c00,0x0c00,0x0c00,
    0x7f80,0x0c00,0x0c00,0x0c00,
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR ,
  {
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0e00,0x0e00,0x1800,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR -
  {
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
    0x7f80,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR .
  {
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
    0x0e00,0x0e00,0x0e00,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR /
  {
    0x0000,0x0000,0x0000,0x0180,
    0x0180,0x0300,0x0300,0x0600,
    0x0600,0x0c00,0x0c00,0x1800,
    0x1800,0x3000,0x3000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR 0
  {
    0x0000,0x0000,0x0c00,0x1e00,
    0x3300,0x3300,0x6180,0x6180,
    0x6180,0x6180,0x6180,0x3300,
    0x3300,0x1e00,0x0c00,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR 1
  {
    0x0000,0x0000,0x0c00,0x1c00,
    0x3c00,0x6c00,0x0c00,0x0c00,
    0x0c00,0x0c00,0x0c00,0x0c00,
    0x0c00,0x0c00,0x7f80,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR 2
  {
    0x0000,0x0000,0x1e00,0x3300,
    0x6180,0x6180,0x0180,0x0180,
    0x0300,0x0e00,0x1800,0x3000,
    0x6000,0x6000,0x7f80,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR 3
  {
    0x0000,0x0000,0x1e00,0x3300,
    0x6180,0x6180,0x0180,0x0300,
    0x0e00,0x0300,0x0180,0x6180,
    0x6180,0x3300,0x1e00,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR 4
  {
    0x0000,0x0000,0x0100,0x0300,
    0x0700,0x0f00,0x1b00,0x3300,
    0x6300,0x6300,0x7f80,0x0300,
    0x0300,0x0300,0x0300,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR 5
  {
    0x0000,0x0000,0x7f80,0x6000,
    0x6000,0x6000,0x6000,0x6e00,
    0x7300,0x0180,0x0180,0x0180,
    0x6180,0x3300,0x1e00,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR 6
  {
    0x0000,0x0000,0x1e00,0x3300,
    0x6100,0x6000,0x6000,0x6e00,
    0x7300,0x6180,0x6180,0x6180,
    0x6180,0x3300,0x1e00,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR 7
  {
    0x0000,0x0000,0x7f80,0x0180,
    0x0180,0x0300,0x0300,0x0600,
    0x0600,0x0c00,0x0c00,0x1800,
    0x1800,0x3000,0x3000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR 8
  {
    0x0000,0x0000,0x1e00,0x3300,
    0x6180,0x6180,0x6180,0x3300,
    0x1e00,0x3300,0x6180,0x6180,
    0x6180,0x3300,0x1e00,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR 9
  {
    0x0000,0x0000,0x1e00,0x3300,
    0x6180,0x6180,0x6180,0x6180,
    0x3380,0x1d80,0x0180,0x0180,
    0x2180,0x3300,0x1e00,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR :
  {
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0e00,0x0e00,0x0000,
    0x0000,0x0000,0x0000,0x0e00,
    0x0e00,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR ;
  {
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0e00,0x0e00,0x0000,
    0x0000,0x0000,0x0000,0x0e00,
    0x0e00,0x1c00,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR <
  {
    0x0000,0x0000,0x0100,0x0300,
    0x0600,0x0c00,0x1800,0x3000,
    0x6000,0x3000,0x1800,0x0c00,
    0x0600,0x0300,0x0100,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR =
  {
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x7f80,0x0000,
    0x0000,0x0000,0x0000,0x7f80,
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR >
  {
    0x0000,0x0000,0x2000,0x3000,
    0x1800,0x0c00,0x0600,0x0300,
    0x0180,0x0300,0x0600,0x0c00,
    0x1800,0x3000,0x2000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR ?
  {
    0x0000,0x0000,0x1e00,0x3300,
    0x6180,0x6180,0x6180,0x0300,
    0x0600,0x0c00,0x0c00,0x0c00,
    0x0000,0x0c00,0x0c00,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR @
  {
    0x0000,0x0000,0x1e00,0x3300,
    0x6180,0x6780,0x6f80,0x6d80,
    0x6d80,0x6d80,0x6f00,0x6600,
    0x6000,0x3180,0x1f00,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR A
  {
    0x0000,0x0000,0x0c00,0x1e00,
    0x3300,0x3300,0x6180,0x6180,
    0x6180,0x7f80,0x6180,0x6180,
    0x6180,0x6180,0x6180,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR B
  {
    0x0000,0x0000,0x7c00,0x6600,
    0x6300,0x6300,0x6300,0x6600,
    0x7e00,0x6300,0x6180,0x6180,
    0x6180,0x6300,0x7e00,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR C
  {
    0x0000,0x0000,0x1e00,0x3300,
    0x6180,0x6000,0x6000,0x6000,
    0x6000,0x6000,0x6000,0x6000,
    0x6180,0x3300,0x1e00,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR D
  {
    0x0000,0x0000,0x7e00,0x6300,
    0x6180,0x6180,0x6180,0x6180,
    0x6180,0x6180,0x6180,0x6180,
    0x6180,0x6300,0x7e00,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR E
  {
    0x0000,0x0000,0x7f80,0x6000,
    0x6000,0x6000,0x6000,0x6000,
    0x7e00,0x6000,0x6000,0x6000,
    0x6000,0x6000,0x7f80,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR F
  {
    0x0000,0x0000,0x7f80,0x6000,
    0x6000,0x6000,0x6000,0x6000,
    0x7e00,0x6000,0x6000,0x6000,
    0x6000,0x6000,0x6000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR G
  {
    0x0000,0x0000,0x1e00,0x3300,
    0x6180,0x6000,0x6000,0x6000,
    0x6780,0x6180,0x6180,0x6180,
    0x6180,0x3380,0x1e80,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR H
  {
    0x0000,0x0000,0x6180,0x6180,
    0x6180,0x6180,0x6180,0x6180,
    0x7f80,0x6180,0x6180,0x6180,
    0x6180,0x6180,0x6180,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR I
  {
    0x0000,0x0000,0x7f80,0x0c00,
    0x0c00,0x0c00,0x0c00,0x0c00,
    0x0c00,0x0c00,0x0c00,0x0c00,
    0x0c00,0x0c00,0x7f80,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR J
  {
    0x0000,0x0000,0x0f80,0x0180,
    0x0180,0x0180,0x0180,0x0180,
    0x0180,0x0180,0x0180,0x6180,
    0x6180,0x3300,0x1e00,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR K
  {
    0x0000,0x0000,0x6180,0x6180,
    0x6300,0x6300,0x6600,0x6600,
    0x7c00,0x6600,0x6600,0x6300,
    0x6300,0x6180,0x6180,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR L
  {
    0x0000,0x0000,0x6000,0x6000,
    0x6000,0x6000,0x6000,0x6000,
    0x6000,0x6000,0x6000,0x6000,
    0x6000,0x6000,0x7f80,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR M
  {
    0x0000,0x0000,0x6180,0x6180,
    0x7380,0x7380,0x7f80,0x6d80,
    0x6d80,0x6d80,0x6d80,0x6180,
    0x6180,0x6180,0x6180,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR N
  {
    0x0000,0x0000,0x6180,0x7180,
    0x7180,0x7980,0x7980,0x6d80,
    0x6d80,0x6780,0x6780,0x6380,
    0x6380,0x6180,0x6180,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR O
  {
    0x0000,0x0000,0x1e00,0x3300,
    0x6180,0x6180,0x6180,0x6180,
    0x6180,0x6180,0x6180,0x6180,
    0x6180,0x3300,0x1e00,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR P
  {
    0x0000,0x0000,0x7e00,0x6300,
    0x6180,0x6180,0x6180,0x6180,
    0x6300,0x7e00,0x6000,0x6000,
    0x6000,0x6000,0x6000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR Q
  {
    0x0000,0x0000,0x1e00,0x3300,
    0x6180,0x6180,0x6180,0x6180,
    0x6180,0x6180,0x6180,0x6d80,
    0x6780,0x3300,0x1f00,0x0180,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR R
  {
    0x0000,0x0000,0x7e00,0x6300,
    0x6180,0x6180,0x6180,0x6180,
    0x6300,0x7e00,0x6600,0x6300,
    0x6300,0x6180,0x6180,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR S
  {
    0x0000,0x0000,0x1e00,0x3300,
    0x6180,0x6000,0x6000,0x3000,
    0x1e00,0x0300,0x0180,0x0180,
    0x6180,0x3300,0x1e00,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR T
  {
    0x0000,0x0000,0x7f80,0x0c00,
    0x0c00,0x0c00,0x0c00,0x0c00,
    0x0c00,0x0c00,0x0c00,0x0c00,
    0x0c00,0x0c00,0x0c00,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR U
  {
    0x0000,0x0000,0x6180,0x6180,
    0x6180,0x6180,0x6180,0x6180,
    0x6180,0x6180,0x6180,0x6180,
    0x6180,0x3300,0x1e00,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR V
  {
    0x0000,0x0000,0x6180,0x6180,
    0x6180,0x6180,0x3300,0x3300,
    0x3300,0x1e00,0x1e00,0x1e00,
    0x0c00,0x0c00,0x0c00,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR W
  {
    0x0000,0x0000,0x6180,0x6180,
    0x6180,0x6180,0x6180,0x6d80,
    0x6d80,0x6d80,0x6d80,0x7380,
    0x7380,0x6180,0x6180,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR X
  {
    0x0000,0x0000,0x6180,0x6180,
    0x3300,0x3300,0x1e00,0x1e00,
    0x0c00,0x1e00,0x1e00,0x3300,
    0x3300,0x6180,0x6180,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR Y
  {
    0x0000,0x0000,0x6180,0x6180,
    0x3300,0x3300,0x1e00,0x1e00,
    0x0c00,0x0c00,0x0c00,0x0c00,
    0x0c00,0x0c00,0x0c00,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR Z
  {
    0x0000,0x0000,0x7f80,0x0180,
    0x0180,0x0300,0x0600,0x0600,
    0x0c00,0x1800,0x1800,0x3000,
    0x6000,0x6000,0x7f80,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR [
  {
    0x0000,0x0000,0x3f00,0x3000,
    0x3000,0x3000,0x3000,0x3000,
    0x3000,0x3000,0x3000,0x3000,
    0x3000,0x3000,0x3f00,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR 
  {
    0x0000,0x0000,0x0000,0x3000,
    0x3000,0x1800,0x1800,0x0c00,
    0x0c00,0x0600,0x0600,0x0300,
    0x0300,0x0180,0x0180,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR ]
  {
    0x0000,0x0000,0x3f00,0x0300,
    0x0300,0x0300,0x0300,0x0300,
    0x0300,0x0300,0x0300,0x0300,
    0x0300,0x0300,0x3f00,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR ^
  {
    0x0000,0x0000,0x0c00,0x1e00,
    0x3300,0x6180,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR _
  {
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x7fc0,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR `
  {
    0x0000,0x0000,0x3c00,0x1c00,
    0x0600,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR a
  {
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x1f00,
    0x3180,0x0180,0x3f80,0x6180,
    0x6180,0x6180,0x3e80,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR b
  {
    0x0000,0x0000,0x6000,0x6000,
    0x6000,0x6000,0x6000,0x6e00,
    0x7300,0x6180,0x6180,0x6180,
    0x6180,0x7300,0x6e00,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR c
  {
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x1f00,
    0x3180,0x6000,0x6000,0x6000,
    0x6000,0x3180,0x1f00,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR d
  {
    0x0000,0x0000,0x0180,0x0180,
    0x0180,0x0180,0x0180,0x1d80,
    0x3380,0x6180,0x6180,0x6180,
    0x6180,0x3380,0x1d80,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR e
  {
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x1e00,
    0x3300,0x6180,0x7f80,0x6000,
    0x6000,0x3180,0x1f00,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR f
  {
    0x0000,0x0000,0x0f00,0x1980,
    0x1980,0x1800,0x1800,0x1800,
    0x1800,0x7e00,0x1800,0x1800,
    0x1800,0x1800,0x1800,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR g
  {
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x3e80,
    0x6380,0x6300,0x6300,0x6300,
    0x3e00,0x6000,0x3f00,0x6180,
    0x6180,0x6180,0x3f00,0x0000,
  },
  //STARTCHAR h
  {
    0x0000,0x0000,0x6000,0x6000,
    0x6000,0x6000,0x6000,0x6e00,
    0x7300,0x6180,0x6180,0x6180,
    0x6180,0x6180,0x6180,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR i
  {
    0x0000,0x0000,0x0000,0x0000,
    0x0c00,0x0c00,0x0000,0x3c00,
    0x0c00,0x0c00,0x0c00,0x0c00,
    0x0c00,0x0c00,0x7f80,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR j
  {
    0x0000,0x0000,0x0000,0x0000,
    0x0180,0x0180,0x0000,0x0780,
    0x0180,0x0180,0x0180,0x0180,
    0x0180,0x0180,0x0180,0x3180,
    0x3180,0x3180,0x1f00,0x0000,
  },
  //STARTCHAR k
  {
    0x0000,0x0000,0x6000,0x6000,
    0x6000,0x6000,0x6000,0x6300,
    0x6600,0x6c00,0x7800,0x7c00,
    0x6600,0x6300,0x6180,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR l
  {
    0x0000,0x0000,0x3c00,0x0c00,
    0x0c00,0x0c00,0x0c00,0x0c00,
    0x0c00,0x0c00,0x0c00,0x0c00,
    0x0c00,0x0c00,0x7f80,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR m
  {
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x5b00,
    0x7f80,0x6d80,0x6d80,0x6d80,
    0x6d80,0x6d80,0x6d80,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR n
  {
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x6e00,
    0x7300,0x6180,0x6180,0x6180,
    0x6180,0x6180,0x6180,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR o
  {
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x1e00,
    0x3300,0x6180,0x6180,0x6180,
    0x6180,0x3300,0x1e00,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR p
  {
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x6e00,
    0x7300,0x6180,0x6180,0x6180,
    0x6180,0x7300,0x6e00,0x6000,
    0x6000,0x6000,0x6000,0x0000,
  },
  //STARTCHAR q
  {
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x1d80,
    0x3380,0x6180,0x6180,0x6180,
    0x6180,0x3380,0x1d80,0x0180,
    0x0180,0x0180,0x0180,0x0000,
  },
  //STARTCHAR r
  {
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x6f00,
    0x3980,0x3000,0x3000,0x3000,
    0x3000,0x3000,0x3000,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR s
  {
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x3f00,
    0x6180,0x6000,0x3f00,0x0180,
    0x0180,0x6180,0x3f00,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR t
  {
    0x0000,0x0000,0x0000,0x0000,
    0x1800,0x1800,0x1800,0x7e00,
    0x1800,0x1800,0x1800,0x1800,
    0x1800,0x1980,0x0f00,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR u
  {
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x6180,
    0x6180,0x6180,0x6180,0x6180,
    0x6180,0x3380,0x1d80,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR v
  {
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x6180,
    0x6180,0x3300,0x3300,0x1e00,
    0x1e00,0x0c00,0x0c00,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR w
  {
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x6180,
    0x6180,0x6180,0x6d80,0x6d80,
    0x6d80,0x7f80,0x3300,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR x
  {
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x6180,
    0x3300,0x1e00,0x0c00,0x0c00,
    0x1e00,0x3300,0x6180,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  },
  //STARTCHAR y
  {
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x6180,
    0x6180,0x6180,0x6180,0x6180,
    0x6180,0x3380,0x1d80,0x0180,
    0x6180,0x3300,0x1e00,0x0000,
  },
  //STARTCHAR z
  {
    0x0000,0x0000,0x0000,0x0000,
    0x0000,0x0000,0x0000,0x3f80,
    0x0180,0x0300,0x0600,0x0c00,
    0x1800,0x3000,0x3f80,0x0000,
    0x0000,0x0000,0x0000,0x0000,
  }
};

template <typename pixel_t>
void cpu_draw_text(
  pixel_t* dst, int width, int height, int pitch,
  const char* __restrict__ charmap, int mapw, int maph, int mappitch,
  int logx, int logy, int pixelshift, bool isUV)
{
  for (int by = 0; by < maph; ++by) {
    for (int bx = 0; bx < mapw; ++bx) {
      for (int ty = 0; ty < 20; ty += (1 << logy)) {
        for (int tx = 0; tx < 10; tx += (1 << logx)) {
          int x = (tx + bx * 10) >> logx;
          int y = (ty + by * 20) >> logy;

          if (x < width && y < height) {
            int c = charmap[bx + by * mappitch] - ' ';
            if (c >= 0 && c <= 'z' - ' ') {
              if (font[c][ty] & (1 << (15 - tx))) {
                dst[x + y * pitch] = isUV ? (128 << pixelshift) : (235 << pixelshift);
              }
              else {
                dst[x + y * pitch] = (dst[x + y * pitch] + (isUV ? (128 << pixelshift) : 0)) >> 1;
              }
            }
          }
        }
      }
    }
  }
}

// threads: (10 >> logx, 20 >> logy)
template <typename pixel_t>
__global__ void kl_draw_text(
  pixel_t* dst, int width, int height, int pitch,
  const char* __restrict__ charmap, int mapw, int maph, int mappitch,
  int logx, int logy, int pixelshift, bool isUV)
{
  int bx = blockIdx.x;
  int by = blockIdx.y;
  int tx = threadIdx.x << logx;
  int ty = threadIdx.y << logy;
  int x = (tx + bx * 10) >> logx;
  int y = (ty + by * 20) >> logy;

  if (x < width && y < height) {
    int c = charmap[bx + by * mappitch] - ' ';
    if (c >= 0 && c <= 'z' - ' ') {
      if (font[c][ty] & (1 << (15 - tx))) {
        dst[x + y * pitch] = isUV ? (128 << pixelshift) : (235 << pixelshift);
      }
      else {
        dst[x + y * pitch] = (dst[x + y * pitch] + (isUV ? (128 << pixelshift) : 0)) >> 1;
      }
    }
  }
}

static std::vector<std::string> split_string(const std::string& str,
  const std::string& delimiter)
{
  std::vector<std::string> strings;

  std::string::size_type pos = 0;
  std::string::size_type prev = 0;
  while ((pos = str.find(delimiter, prev)) != std::string::npos)
  {
    strings.push_back(str.substr(prev, pos - prev));
    prev = pos + 1;
  }

  // To get the last substring (or only, if delimiter is not found)
  strings.push_back(str.substr(prev));

  return strings;
}

template <typename pixel_t>
void DrawText(PVideoFrame &dst_, int bitsPerComponent, int x1, int y1, const std::string& s, PNeoEnv env)
{
  // YUV planar しか対応しない
  Frame dst = Frame(dst_, x1, y1, 0, 0, sizeof(pixel_t));
  dst_ = nullptr; // move

  env->MakeWritable(&dst.frame);

  // 文字列を２次元に展開したデータを作ってGPUに転送
  auto lines = split_string(s, "\n");
  int maxlen = (int)std::max_element(lines.begin(), lines.end(),
    [](const std::string& s0, const std::string& s1) {
    return s0.size() < s1.size();
  })->size();

  if (maxlen > 0) {
    char* charmap = new char[maxlen * lines.size()]();
    for (int i = 0; i < (int)lines.size(); ++i) {
      const std::string& str = lines[i];
      std::copy(str.begin(), str.end(), &charmap[i * maxlen]);
    }

    pixel_t* dstY = dst.GetWritePtr<pixel_t>(PLANAR_Y);
    pixel_t* dstU = dst.GetWritePtr<pixel_t>(PLANAR_U);
    pixel_t* dstV = dst.GetWritePtr<pixel_t>(PLANAR_V);

    int pitch = dst.GetPitch<pixel_t>(PLANAR_Y);
    int pitchUV = dst.GetPitch<pixel_t>(PLANAR_U);
    int width = std::min(dst.GetWidth<pixel_t>(PLANAR_Y), maxlen * 10);
    int height = std::min(dst.GetHeight(PLANAR_Y), (int)lines.size() * 20);
    int logx = (dst.GetWidth<pixel_t>(PLANAR_U) < dst.GetWidth<pixel_t>(PLANAR_Y)) ? 1 : 0;
    int logy = (dst.GetHeight(PLANAR_U) < dst.GetHeight(PLANAR_Y)) ? 1 : 0;
    int widthUV = width >> logx;
    int heightUV = height >> logy;
    int shift = bitsPerComponent - 8;

    if (IS_CUDA) {
      int work_bytes = sizeof(char) * maxlen * (int)lines.size();
      VideoInfo workvi = VideoInfo();
      workvi.pixel_type = VideoInfo::CS_BGR32;
      workvi.width = 64;
      workvi.height = nblocks(work_bytes, workvi.width * 4);
      PVideoFrame work = env->NewVideoFrame(workvi);
      char* dev_charmap = (char*)work->GetWritePtr();
      CUDA_CHECK(cudaMemcpyAsync(dev_charmap, charmap, work_bytes, cudaMemcpyHostToDevice));

      dim3 threads(10, 20);
      dim3 threadsUV(threads.x >> logx, threads.y >> logy);
      dim3 blocks(maxlen, (int)lines.size());
      DEBUG_SYNC;
      kl_draw_text << <blocks, threads >> > (dstY, width, height, pitch,
        dev_charmap, maxlen, (int)lines.size(), maxlen, 0, 0, shift, false);
      DEBUG_SYNC;
      kl_draw_text << <blocks, threadsUV >> > (dstU, widthUV, heightUV, pitchUV,
        dev_charmap, maxlen, (int)lines.size(), maxlen, logx, logy, shift, true);
      DEBUG_SYNC;
      kl_draw_text << <blocks, threadsUV >> > (dstV, widthUV, heightUV, pitchUV,
        dev_charmap, maxlen, (int)lines.size(), maxlen, logx, logy, shift, true);
      DEBUG_SYNC;

      // 終わったら解放するコールバックを追加
      env->DeviceAddCallback([](void* arg) {
        delete[]((char*)arg);
      }, charmap);
    }
    else {
      cpu_draw_text(dstY, width, height, pitch,
        charmap, maxlen, (int)lines.size(), maxlen, 0, 0, shift, false);
      cpu_draw_text(dstU, widthUV, heightUV, pitchUV,
        charmap, maxlen, (int)lines.size(), maxlen, logx, logy, shift, true);
      cpu_draw_text(dstV, widthUV, heightUV, pitchUV,
        charmap, maxlen, (int)lines.size(), maxlen, logx, logy, shift, true);
      delete[] charmap;
    }
  }

  dst_ = dst.frame;
}

template void DrawText<uint8_t>(PVideoFrame &dst_,
  int bitsPerComponent, int x1, int y1, const std::string& s, PNeoEnv env);
template void DrawText<uint16_t>(PVideoFrame &dst_,
  int bitsPerComponent, int x1, int y1, const std::string& s, PNeoEnv env);


static void DrawYV12(const PVideoFrame &dst, int x1, int y1, const char *s)
{
  int x, y = y1 * 20, num, tx, ty;
  int pitchY = dst->GetPitch(PLANAR_Y), pitchUV = dst->GetPitch(PLANAR_V);
  unsigned char *dpY, *dpU, *dpV;
  unsigned int width = dst->GetRowSize(PLANAR_Y);
  int height = dst->GetHeight(PLANAR_Y);
  if (y + 20 >= height) return;
  for (int xx = 0; *s; ++s, ++xx)
  {
    x = (x1 + xx) * 10;
    if (x + 10 >= (int)(width)) return;
    num = *s - ' ';
    for (tx = 0; tx < 10; tx++)
    {
      for (ty = 0; ty < 20; ty++)
      {
        dpY = &dst->GetWritePtr(PLANAR_Y)[(x + tx) + (y + ty) * pitchY];
        if (font[num][ty] & (1 << (15 - tx))) *dpY = 255;
        else *dpY = (unsigned char)(*dpY >> 1);
      }
    }
    for (tx = 0; tx < 10; tx++)
    {
      for (ty = 0; ty < 20; ty++)
      {
        dpU = &dst->GetWritePtr(PLANAR_U)[((x + tx) / 2) + ((y + ty) / 2) * pitchUV];
        dpV = &dst->GetWritePtr(PLANAR_V)[((x + tx) / 2) + ((y + ty) / 2) * pitchUV];
        if (font[num][ty] & (1 << (15 - tx)))
        {
          *dpU = 128;
          *dpV = 128;
        }
        else
        {
          *dpU = (unsigned char)((*dpU + 128) >> 1);
          *dpV = (unsigned char)((*dpV + 128) >> 1);
        }
      }
    }
  }
}

static void DrawYUY2(const PVideoFrame &dst, int x1, int y1, const char *s)
{
  int x, y = y1 * 20, num, pitch = dst->GetPitch();
  unsigned char *dp;
  unsigned int width = dst->GetRowSize();
  int height = dst->GetHeight();
  if (y + 20 >= height) return;
  for (int xx = 0; *s; ++s, ++xx)
  {
    x = (x1 + xx) * 10;
    if ((x + 10) * 2 >= (int)(width)) return;
    num = *s - ' ';
    for (int tx = 0; tx < 10; tx++)
    {
      for (int ty = 0; ty < 20; ty++)
      {
        dp = &dst->GetWritePtr()[(x + tx) * 2 + (y + ty) * pitch];
        if (font[num][ty] & (1 << (15 - tx)))
        {
          if (tx & 1)
          {
            dp[0] = 255;
            dp[-1] = 128;
            dp[1] = 128;
          }
          else
          {
            dp[0] = 255;
            dp[1] = 128;
            dp[3] = 128;
          }
        }
        else
        {
          if (tx & 1)
          {
            dp[0] = (unsigned char)(dp[0] >> 1);
            dp[-1] = (unsigned char)((dp[-1] + 128) >> 1);
            dp[1] = (unsigned char)((dp[1] + 128) >> 1);
          }
          else
          {
            dp[0] = (unsigned char)(dp[0] >> 1);
            dp[1] = (unsigned char)((dp[1] + 128) >> 1);
            dp[3] = (unsigned char)((dp[3] + 128) >> 1);
          }
        }
      }
    }
  }
}

void DrawText_old(const PVideoFrame &dst, bool isYV12, int x1, int y1, const std::string& s, PNeoEnv env)
{
  if (isYV12) DrawYV12(dst, x1, y1, s.c_str());
  else DrawYUY2(dst, x1, y1, s.c_str());
}
